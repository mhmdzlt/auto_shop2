name: Weekly Health Check

on:
  schedule:
    # ุชุดุบูู ูู ููู ุงุซููู ุงูุณุงุนุฉ 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # ุฅููุงููุฉ ุงูุชุดุบูู ุงููุฏูู

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Project Health Report
      run: |
        echo "๐ฅ ===== ุชูุฑูุฑ ุตุญุฉ ุงููุดุฑูุน ุงูุฃุณุจูุนู ====="
        echo "๐ $(date)"
        echo ""
        
        # ุฅุญุตุงุฆูุงุช ุนุงูุฉ
        echo "๐ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ:"
        TOTAL_DART_FILES=$(find . -name "*.dart" | wc -l)
        TOTAL_LINES=$(find . -name "*.dart" -exec cat {} \; | wc -l)
        echo "- ุฅุฌูุงูู ูููุงุช Dart: $TOTAL_DART_FILES"
        echo "- ุฅุฌูุงูู ุฃุณุทุฑ ุงูููุฏ: $TOTAL_LINES"
        
        # ุญุงูุฉ ุงูุชุจุนูุงุช
        echo ""
        echo "๐ฆ ุญุงูุฉ ุงูุชุจุนูุงุช:"
        flutter pub outdated || echo "ุฌููุน ุงูุชุจุนูุงุช ูุญุฏุซุฉ"
        
        # ูุญุต ุงูุฃูุงู
        echo ""
        echo "๐ ูุญุต ุงูุฃูุงู:"
        flutter pub audit || echo "โ๏ธ ูุฏ ุชูุฌุฏ ูุดุงูู ุฃูููุฉ"
        
        # ุญุงูุฉ ุงูุงุฎุชุจุงุฑุงุช
        echo ""
        echo "๐งช ุญุงูุฉ ุงูุงุฎุชุจุงุฑุงุช:"
        if flutter test --reporter json > test_results.json 2>/dev/null; then
          echo "โ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุชุนูู"
        else
          echo "โ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุง ุชุนูู"
        fi
        
        # ุชุญููู ุงูููุฏ
        echo ""
        echo "๐ ุชุญููู ุงูููุฏ:"
        flutter analyze --no-fatal-infos > analysis.txt 2>&1
        if grep -q "No issues found" analysis.txt; then
          echo "โ ุงูููุฏ ูุธูู"
        else
          ISSUES_COUNT=$(grep -c "info\|warning\|error" analysis.txt || echo 0)
          echo "โ๏ธ ุชู ุงูุนุซูุฑ ุนูู $ISSUES_COUNT ูุดููุฉ"
        fi
        
        # ุญุฌู ุงููุดุฑูุน
        echo ""
        echo "๐ ุญุฌู ุงููุดุฑูุน:"
        PROJECT_SIZE=$(du -sh . | cut -f1)
        echo "- ุญุฌู ุงููุดุฑูุน: $PROJECT_SIZE"
        
        # ูุนุฏู ุงูููู (ุชูุฑูุจู)
        COMMITS_THIS_WEEK=$(git log --since="1 week ago" --oneline | wc -l || echo "ุบูุฑ ูุชุงุญ")
        echo "- ุนุฏุฏ ุงูู commits ูุฐุง ุงูุฃุณุจูุน: $COMMITS_THIS_WEEK"

    - name: Performance Recommendations
      run: |
        echo ""
        echo "โก ุชูุตูุงุช ุงูุฃุฏุงุก:"
        
        # ูุญุต ุงูุตูุฑ ุงููุจูุฑุฉ
        LARGE_IMAGES=$(find assets -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9}' | wc -l || echo 0)
        if [ $LARGE_IMAGES -gt 0 ]; then
          echo "โ๏ธ ุชูุฌุฏ $LARGE_IMAGES ุตูุฑ ูุจูุฑุฉ (>1MB) - ููุฑ ูู ุถุบุทูุง"
        else
          echo "โ ุฃุญุฌุงู ุงูุตูุฑ ููุงุณุจุฉ"
        fi
        
        # ูุญุต ุงูุงุณุชูุฑุงุฏุงุช ุงูุฒุงุฆุฏุฉ
        UNUSED_IMPORTS=$(flutter analyze 2>&1 | grep -c "Unused import" || echo 0)
        if [ $UNUSED_IMPORTS -gt 0 ]; then
          echo "๐งน ูููู ุญุฐู $UNUSED_IMPORTS ุงุณุชูุฑุงุฏ ุบูุฑ ูุณุชุฎุฏู"
        else
          echo "โ ุงูุงุณุชูุฑุงุฏุงุช ูุญุณูุฉ"
        fi

    - name: Security Recommendations
      run: |
        echo ""
        echo "๐ ุชูุตูุงุช ุงูุฃูุงู:"
        
        # ูุญุต ุงููููุงุช ุงูุญุณุงุณุฉ
        if [ -f "android/app/google-services.json" ]; then
          echo "โ๏ธ ุชุฃูุฏ ูู ุฃู google-services.json ูู .gitignore"
        fi
        
        if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
          echo "โ๏ธ ุชุฃูุฏ ูู ุฃู GoogleService-Info.plist ูู .gitignore"
        fi
        
        # ูุญุต ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
        if grep -r "API_KEY\|SECRET\|PASSWORD" . --include="*.dart" --exclude-dir=.git >/dev/null 2>&1; then
          echo "โ๏ธ ูุฏ ุชูุฌุฏ ููุงุชูุญ API ูู ุงูููุฏ - ุงุณุชุฎุฏู ูุชุบูุฑุงุช ุงูุจูุฆุฉ"
        else
          echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุงุชูุญ ููุดููุฉ"
        fi

    - name: Growth Insights
      run: |
        echo ""
        echo "๐ ุฑุคู ุงูููู:"
        
        # ุชุทูุฑ ุงููุดุฑูุน
        PAGES_COUNT=$(find lib/pages -name "*.dart" 2>/dev/null | wc -l || echo 0)
        WIDGETS_COUNT=$(find lib/widgets -name "*.dart" 2>/dev/null | wc -l || echo 0)
        PROVIDERS_COUNT=$(find lib/providers -name "*.dart" 2>/dev/null | wc -l || echo 0)
        
        echo "- ุงูุตูุญุงุช: $PAGES_COUNT"
        echo "- ุงูููุฏุฌุช ุงููุฎุตุตุฉ: $WIDGETS_COUNT"  
        echo "- ูุฒูุฏู ุงูุญุงูุฉ: $PROVIDERS_COUNT"
        
        # ูุตุงุฆุญ ููููู
        if [ $PAGES_COUNT -gt 20 ]; then
          echo "๐ก ููุฑ ูู ุชุฌููุน ุงูุตูุญุงุช ูู ูุฌูุฏุงุช ูุฑุนูุฉ"
        fi
        
        if [ $WIDGETS_COUNT -gt 30 ]; then
          echo "๐ก ููุฑ ูู ุฅูุดุงุก ููุชุจุฉ ููุฏุฌุช ูููุตูุฉ"
        fi

    - name: Weekly Summary
      run: |
        echo ""
        echo "๐ ===== ููุฎุต ุงูุฃุณุจูุน ====="
        echo "๐ฏ ูุดุฑูุน Auto Shop ูู ุญุงูุฉ ุฌูุฏุฉ!"
        echo "๐ ุงููุดุฑูุน ูููู ุจุดูู ุตุญู"
        echo "๐ง ุชุงุจุน ุงูุชูุตูุงุช ูุชุญุณูู ุงูุฃุฏุงุก"
        echo "๐ ุญุงูุธ ุนูู ูุนุงููุฑ ุงูุฃูุงู"
        echo ""
        echo "๐ ุงุณุชูุฑ ูู ุงูุชุทููุฑ ุงูุฑุงุฆุน!"
        echo ""
        echo "๐ ุงูุชูุฑูุฑ ุงููุงุฏู: ุงูุฃุณุจูุน ุงูููุจู"
