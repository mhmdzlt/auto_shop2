name: Advanced Code Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # ุชุดุบูู ุฃุณุจูุนู ูู ููู ุฃุญุฏ ุงูุณุงุนุฉ 02:00 UTC
    - cron: '0 2 * * 0'

jobs:
  advanced-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.6'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Code Metrics Analysis
      run: |
        echo "๐ ===== ุชุญููู ููุงููุณ ุงูููุฏ ====="
        echo ""
        
        # ุชุญููู ุงูุชุนููุฏ
        echo "๐ ุชุญููู ุงูุชุนููุฏ (Cyclomatic Complexity):"
        for file in $(find lib -name "*.dart"); do
          complexity=$(grep -o "if\|for\|while\|switch\|catch\|\&\&\|\|\|" "$file" | wc -l)
          if [ $complexity -gt 10 ]; then
            echo "โ๏ธ  $file: ุชุนููุฏ ุนุงูู ($complexity)"
          fi
        done
        
        # ุชุญููู ุทูู ุงููููุงุช
        echo ""
        echo "๐ ุชุญููู ุทูู ุงููููุงุช:"
        for file in $(find lib -name "*.dart"); do
          lines=$(wc -l < "$file")
          if [ $lines -gt 500 ]; then
            echo "โ๏ธ  $file: ููู ุทููู ($lines ุณุทุฑ)"
          fi
        done
        
        # ุชุญููู ุงูุงุณุชูุฑุงุฏุงุช
        echo ""
        echo "๐ฆ ุชุญููู ุงูุงุณุชูุฑุงุฏุงุช:"
        UNUSED_IMPORTS=$(flutter analyze 2>&1 | grep -c "Unused import" || echo 0)
        echo "- ุงูุงุณุชูุฑุงุฏุงุช ุบูุฑ ุงููุณุชุฎุฏูุฉ: $UNUSED_IMPORTS"
        
        # ุชุญููู TODO ู FIXME
        echo ""
        echo "๐ ุชุญููู ุงูููุงู ุงููุนููุฉ:"
        TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK" lib --include="*.dart" | wc -l)
        echo "- ุนุฏุฏ ุงูููุงู ุงููุนููุฉ: $TODO_COUNT"
        if [ $TODO_COUNT -gt 0 ]; then
          echo "๐ ุงูููุงู ุงููุนููุฉ:"
          grep -r "TODO\|FIXME\|HACK" lib --include="*.dart" -n | head -10
        fi

    - name: Performance Analysis
      run: |
        echo ""
        echo "โก ===== ุชุญููู ุงูุฃุฏุงุก ====="
        echo ""
        
        # ุชุญููู ุงูููุฏุฌุช ุงูุซูููุฉ
        echo "๐๏ธ ุชุญููู ุงูููุฏุฌุช ุงูุซูููุฉ:"
        LISTVIEW_COUNT=$(grep -r "ListView\|GridView" lib --include="*.dart" | wc -l)
        FUTUREBUILDER_COUNT=$(grep -r "FutureBuilder" lib --include="*.dart" | wc -l)
        STREAMBUILDER_COUNT=$(grep -r "StreamBuilder" lib --include="*.dart" | wc -l)
        echo "- ListView/GridView: $LISTVIEW_COUNT"
        echo "- FutureBuilder: $FUTUREBUILDER_COUNT"
        echo "- StreamBuilder: $STREAMBUILDER_COUNT"
        
        # ุชุญููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ
        echo ""
        echo "๐พ ุชุญููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ:"
        IMAGE_COUNT=$(grep -r "Image\." lib --include="*.dart" | wc -l)
        NETWORK_IMAGE_COUNT=$(grep -r "Image.network\|NetworkImage" lib --include="*.dart" | wc -l)
        echo "- ุงุณุชุฎุฏุงู ุงูุตูุฑ: $IMAGE_COUNT"
        echo "- ุงูุตูุฑ ูู ุงูุดุจูุฉ: $NETWORK_IMAGE_COUNT"

    - name: Security Analysis
      run: |
        echo ""
        echo "๐ ===== ุชุญููู ุงูุฃูุงู ====="
        echo ""
        
        # ูุญุต ุงูููุงุชูุญ ุงูุตูุจุฉ
        echo "๐ ูุญุต ุงูููุงุชูุญ ุงูุตูุจุฉ:"
        HARDCODED_SECRETS=$(grep -r "password\|secret\|key\|token" lib --include="*.dart" -i | grep -v "// " | wc -l)
        if [ $HARDCODED_SECRETS -gt 0 ]; then
          echo "โ๏ธ  ุชู ุงูุนุซูุฑ ุนูู $HARDCODED_SECRETS ููุชุงุญ ูุญุชูู"
        else
          echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู ููุงุชูุญ ุตูุจุฉ"
        fi
        
        # ูุญุต HTTP ุบูุฑ ุงูุขูู
        echo ""
        echo "๐ ูุญุต ุงูุงุชุตุงูุงุช ุบูุฑ ุงูุขููุฉ:"
        HTTP_COUNT=$(grep -r "http://" lib --include="*.dart" | wc -l)
        if [ $HTTP_COUNT -gt 0 ]; then
          echo "โ๏ธ  ุชู ุงูุนุซูุฑ ุนูู $HTTP_COUNT ุงุชุตุงู HTTP ุบูุฑ ุขูู"
        else
          echo "โ ุฌููุน ุงูุงุชุตุงูุงุช ุขููุฉ (HTTPS)"
        fi

    - name: Architecture Analysis
      run: |
        echo ""
        echo "๐๏ธ ===== ุชุญููู ุงูุจููุฉ ====="
        echo ""
        
        # ุชุญููู ุงูุทุจูุงุช
        echo "๐ ุชุญููู ุงูุทุจูุงุช:"
        UI_FILES=$(find lib -path "*/pages/*" -o -path "*/widgets/*" -name "*.dart" | wc -l)
        LOGIC_FILES=$(find lib -path "*/providers/*" -o -path "*/services/*" -name "*.dart" | wc -l)
        DATA_FILES=$(find lib -path "*/models/*" -o -path "*/storage/*" -name "*.dart" | wc -l)
        
        echo "- ุทุจูุฉ ูุงุฌูุฉ ุงููุณุชุฎุฏู: $UI_FILES ููู"
        echo "- ุทุจูุฉ ุงูููุทู: $LOGIC_FILES ููู"
        echo "- ุทุจูุฉ ุงูุจูุงูุงุช: $DATA_FILES ููู"
        
        # ูุณุจุฉ ุงูุชูุฒูุน
        TOTAL=$((UI_FILES + LOGIC_FILES + DATA_FILES))
        if [ $TOTAL -gt 0 ]; then
          UI_PERCENT=$((UI_FILES * 100 / TOTAL))
          LOGIC_PERCENT=$((LOGIC_FILES * 100 / TOTAL))
          DATA_PERCENT=$((DATA_FILES * 100 / TOTAL))
          echo ""
          echo "๐ ูุณุจุฉ ุงูุชูุฒูุน:"
          echo "- ูุงุฌูุฉ ุงููุณุชุฎุฏู: ${UI_PERCENT}%"
          echo "- ุงูููุทู: ${LOGIC_PERCENT}%"
          echo "- ุงูุจูุงูุงุช: ${DATA_PERCENT}%"
        fi

    - name: Generate Report
      run: |
        echo ""
        echo "๐ ===== ุชูุฑูุฑ ุดุงูู ====="
        echo ""
        echo "๐ฏ ูุดุฑูุน Auto Shop - ุชูุฑูุฑ ุงูุชุญููู ุงููุชูุฏู"
        echo "๐ ุชุงุฑูุฎ: $(date)"
        echo "๐ Commit: ${{ github.sha }}"
        echo ""
        echo "โ ุชู ุฅููุงู ุงูุชุญููู ุงููุชูุฏู ุจูุฌุงุญ!"
        echo ""
        echo "๐ ูููุฒูุฏ ูู ุงูุชูุงุตููุ ุฑุงุฌุน ุณุฌูุงุช GitHub Actions"
